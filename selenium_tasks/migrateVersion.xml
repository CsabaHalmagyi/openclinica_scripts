<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en"
      xml:lang="en"
      xmlns="http://www.w3.org/1999/xhtml">
    <head profile="http://selenium-ide.openqa.org/profiles/test-case">
        <meta content="text/html; charset=UTF-8"
              http-equiv="Content-Type" />
        <link rel="selenium.base" />
        <title>CRF Migration</title>
    </head>
    <body>
        <table border="1"
               cellpadding="1"
               cellspacing="1">
            <thead>
                <tr>
                    <td colspan="3"
                        rowspan="1">CRF Migration</td>
                </tr>
            </thead>
            <tbody>
                <!--Code is Copyright 2014 VU University Medical Center / Center for Translational Molecular Medicine, and can be reused under the Apache 2.0 license. Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.-->
                <!--Developed by Sander de Ridder, Rinus Voorham and Jeroen Belien, CTMM TRACER and CTMM TraIT-->
                <!--User Variables-->
                <tr>
                    <td>store</td>
                    <td>2</td>
                    <td>eventCol</td>
                </tr>
                <tr>
                    <td>store</td>
                    <td>TRACER Kosten</td>
                    <td>crfName</td>
                </tr>
                <tr>
                    <td>store</td>
                    <td>1.03</td>
                    <td>toVersion</td>
                </tr>
                <tr>
                    <td>store</td>
                    <td>https://yourserver/OpenClinica/</td>
                    <td>instanceURL</td>
                </tr>
                <!--Init-->
                <tr>
                    <td>open</td>
                    <td>${instanceURL}ListStudySubjects</td>
                    <td></td>
                </tr>
                <tr>
                    <td>store</td>
                    <td>1</td>
                    <td>curRowTotal</td>
                </tr>
                <tr>
                    <td>store</td>
                    <td>1</td>
                    <td>curRowOnPage</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>window.document.getElementsByClassName("header")[2].children.length-7</td>
                    <td>nrEvents</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>myString = window.document.getElementsByClassName("statusBar")[0].textContent.trim(); myString.substring(myString.lastIndexOf(" ")+1, myString.lastIndexOf("."));</td>
                    <td>nrRows</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>javascript{String("\""+storedVars['toVersion']+"\"").replace(".", "\\.")}</td>
                    <td>regToVersion</td>
                </tr>
                <tr>
                    <td>store</td>
                    <td>1</td>
                    <td>pageNr</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>storedVars['instanceURL']+"ListStudySubjects?module=admin&amp;maxRows=15&amp;showMoreLink=true&amp;findSubjects_tr_=true&amp;findSubjects_p_="+storedVars['pageNr']+"&amp;findSubjects_mr_=15"</td>
                    <td>page</td>
                </tr>
                <tr>
                    <td>goto</td>
                    <td>next</td>
                    <td></td>
                </tr>
                <!--New Page-->
                <tr>
                    <td>label</td>
                    <td>newPage</td>
                    <td></td>
                </tr>
                <tr>
                    <td>store</td>
                    <td>1</td>
                    <td>curRowOnPage</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>${pageNr}+1</td>
                    <td>pageNr</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>storedVars['instanceURL']+"ListStudySubjects?module=admin&amp;maxRows=15&amp;showMoreLink=true&amp;findSubjects_tr_=true&amp;findSubjects_p_="+storedVars['pageNr']+"&amp;findSubjects_mr_=15"</td>
                    <td>page</td>
                </tr>
                <tr>
                    <td>goto</td>
                    <td>next</td>
                    <td></td>
                </tr>
                <!--Function that opens the main page-->
                <tr>
                    <td>label</td>
                    <td>openPageMain</td>
                    <td></td>
                </tr>
                <tr>
                    <td>open</td>
                    <td>${page}</td>
                    <td></td>
                </tr>
                <tr>
                    <td>goto</td>
                    <td>${returnTo}</td>
                    <td></td>
                </tr>
                <!--Main Loop-->
                <tr>
                    <td>label</td>
                    <td>loop</td>
                    <td></td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>${curRowTotal}+1</td>
                    <td>curRowTotal</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>${curRowOnPage}+1</td>
                    <td>curRowOnPage</td>
                </tr>
                <tr>
                    <td>gotoIf</td>
                    <td>${curRowOnPage}%16==0</td>
                    <td>newPage</td>
                </tr>
                <tr>
                    <td>label</td>
                    <td>next</td>
                    <td></td>
                </tr>
                <tr>
                    <td>store</td>
                    <td>0</td>
                    <td>curRepeat</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>((${curRowOnPage}-1)*${nrEvents})+${eventCol}-1</td>
                    <td>index</td>
                </tr>
                <tr>
                    <td>echo</td>
                    <td>${index}</td>
                    <td></td>
                </tr>
                <!--Continue Main-->
                <tr>
                    <td>store</td>
                    <td>continueMain</td>
                    <td>returnTo</td>
                </tr>
                <tr>
                    <td>gotoIf</td>
                    <td>!window.location.href.contains(storedVars['page'])</td>
                    <td>openPageMain</td>
                </tr>
                <tr>
                    <td>label</td>
                    <td>continueMain</td>
                    <td></td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>myString = window.document.getElementsByClassName("ViewSubjectsPopup")[${index}].innerHTML; myRegexp = /.*Occurrence#1 of (\d+).*/i; match = myRegexp.exec(myString); if(match!==null) maxRepeat = match[1]; else maxRepeat = 1;</td>
                    <td>maxRepeat</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>-1</td>
                    <td>curRepeat</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>if(${maxRepeat}&gt;1) offset = 1; else offset = 0;</td>
                    <td>offset</td>
                </tr>
                <!--Handle Events-->
                <tr>
                    <td>label</td>
                    <td>handleEvents</td>
                    <td></td>
                </tr>
                <tr>
                    <td>store</td>
                    <td>continueHandle</td>
                    <td>returnTo</td>
                </tr>
                <tr>
                    <td>gotoIf</td>
                    <td>!window.location.href.contains(storedVars['page'])</td>
                    <td>openPageMain</td>
                </tr>
                <tr>
                    <td>label</td>
                    <td>continueHandle</td>
                    <td></td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>${curRepeat}+1</td>
                    <td>curRepeat</td>
                </tr>
                <tr>
                    <td>gotoIf</td>
                    <td>${curRepeat} &gt;= ${maxRepeat}</td>
                    <td>checkQuit</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>${offset}+(${curRepeat}*2)</td>
                    <td>repeatIndex</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>window.document.getElementsByClassName("ViewSubjectsPopup")[storedVars['index']].querySelectorAll("tbody")[storedVars['repeatIndex']].innerHTML.contains("not scheduled")</td>
                    <td>skipEntry</td>
                </tr>
                <tr>
                    <td>gotoIf</td>
                    <td>${skipEntry}==true</td>
                    <td>handleEvents</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>window.document.getElementsByClassName("ViewSubjectsPopup")[storedVars['index']].querySelectorAll("tbody")[(storedVars['curRepeat']*2)+1].querySelector("a[href^=Enter]")</td>
                    <td>myLink</td>
                </tr>
                <tr>
                    <td>goto</td>
                    <td>selectCRFPage</td>
                    <td></td>
                </tr>
                <!--Find the row with the CRF-->
                <tr>
                    <td>label</td>
                    <td>findCRFRow</td>
                    <td></td>
                </tr>
                <tr>
                    <td>store</td>
                    <td>0</td>
                    <td>crfIndex</td>
                </tr>
                <tr>
                    <td>label</td>
                    <td>loopFind</td>
                    <td></td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>${crfIndex}+1</td>
                    <td>crfIndex</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>window.document.getElementsByClassName("tablebox_center")[1].firstElementChild.firstElementChild.children[${crfIndex}].firstElementChild.textContent.trim()</td>
                    <td>crfNameFound</td>
                </tr>
                <tr>
                    <td>gotoIf</td>
                    <td>storedVars['crfNameFound']==storedVars['crfName']</td>
                    <td>continueSelectCRFPage</td>
                </tr>
                <tr>
                    <td>goto</td>
                    <td>loopFind</td>
                    <td></td>
                </tr>
                <!--Handle the Change-->
                <tr>
                    <td>label</td>
                    <td>selectCRFPage</td>
                    <td></td>
                </tr>
                <tr>
                    <td>echo</td>
                    <td>${myLink}</td>
                    <td></td>
                </tr>
                <tr>
                    <td>open</td>
                    <td>${myLink}</td>
                    <td></td>
                </tr>
                <tr>
                    <td>goto</td>
                    <td>findCRFRow</td>
                    <td></td>
                </tr>
                <tr>
                    <td>label</td>
                    <td>continueSelectCRFPage</td>
                    <td></td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>window.document.getElementsByClassName("tablebox_center")[1].firstElementChild.firstElementChild.children[${crfIndex}].children[2].firstElementChild.getAttribute("alt")</td>
                    <td>dataEntryStatus</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>(storedVars['dataEntryStatus'] =="Initial Data Entry") || (storedVars['dataEntryStatus']=="Data Entry Complete")</td>
                    <td>changeDataEntry</td>
                </tr>
                <tr>
                    <td>gotoIf</td>
                    <td>${changeDataEntry}==false</td>
                    <td>handleEvents</td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>window.document.getElementsByClassName("tablebox_center")[1].firstElementChild.firstElementChild.children[${crfIndex}].children[5].firstElementChild.firstElementChild.firstElementChild.lastElementChild.lastElementChild.getAttribute("href")</td>
                    <td>myLink2</td>
                </tr>
                <!--Now the actual Migration-->
                <tr>
                    <td>label</td>
                    <td>openLink</td>
                    <td></td>
                </tr>
                <tr>
                    <td>open</td>
                    <td>${instanceURL}${myLink2}</td>
                    <td></td>
                </tr>
                <tr>
                    <td>storeEval</td>
                    <td>window.document.getElementById("selectedVersion").innerHTML.contains("&gt;&amp;nbsp;"+storedVars['toVersion']+"&amp;nbsp;&lt;")</td>
                    <td>hasVersion</td>
                </tr>
                <tr>
                    <td>gotoIf</td>
                    <td>${hasVersion}==false</td>
                    <td>handleEvents</td>
                </tr>
                <tr>
                    <td>select</td>
                    <td>id=selectedVersion</td>
                    <td>regexp:\s${regToVersion}\s</td>
                </tr>
                <tr>
                    <td>clickAndWait</td>
                    <td>name=confirmCRFVersionSubmit</td>
                    <td></td>
                </tr>
                <tr>
                    <td>clickAndWait</td>
                    <td>name=Submit</td>
                    <td></td>
                </tr>
                <tr>
                    <td>goto</td>
                    <td>handleEvents</td>
                    <td></td>
                </tr>
                <!--Check whether to quit-->
                <tr>
                    <td>label</td>
                    <td>checkQuit</td>
                    <td></td>
                </tr>
                <tr>
                    <td>gotoIf</td>
                    <td>${curRowTotal}&lt;(${nrRows})</td>
                    <td>loop</td>
                </tr>
                <tr>
                    <td>label</td>
                    <td>end</td>
                    <td></td>
                </tr>
                <!--Finally return to the subject matrix-->
                <tr>
                    <td>open</td>
                    <td>${instanceURL}ListStudySubjects</td>
                    <td></td>
                </tr>
                <tr>
                    <td>echo</td>
                    <td>Done</td>
                    <td></td>
                </tr>
                <!--Tested for OC 3.3-->
            </tbody>
        </table>
    </body>
</html>
